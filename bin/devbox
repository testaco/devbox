#!/bin/bash
set -euo pipefail

# Devbox CLI - Manage isolated, authenticated development containers
# Version: 0.1.0

# Constants
readonly DEVBOX_IMAGE="devbox-base:latest"
readonly DEVBOX_VOLUME="devbox-credentials"
readonly CONTAINER_PREFIX="devbox-"
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Colors for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[0;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${BLUE}INFO:${NC} $*"
}

log_success() {
    echo -e "${GREEN}✓${NC} $*"
}

log_warning() {
    echo -e "${YELLOW}⚠${NC} $*"
}

log_error() {
    echo -e "${RED}✗${NC} $*" >&2
}

# Check if Docker is running
check_docker() {
    if ! docker info >/dev/null 2>&1; then
        log_error "Docker is not running or not accessible"
        log_error "Please start Docker and try again"
        exit 1
    fi
}

# Build the base image if it doesn't exist
ensure_image() {
    if ! docker image inspect "$DEVBOX_IMAGE" >/dev/null 2>&1; then
        log_info "Building devbox base image..."
        if ! docker build -t "$DEVBOX_IMAGE" "$PROJECT_ROOT/docker"; then
            log_error "Failed to build devbox base image"
            exit 1
        fi
        log_success "Base image built successfully"
    fi
}

# Resolve container name or ID to full container ID
resolve_container() {
    local name_or_id="$1"
    local container_id

    # First try exact name match with prefix
    if container_id=$(docker ps -aq --filter "name=^${CONTAINER_PREFIX}${name_or_id}$" 2>/dev/null) && [[ -n "$container_id" ]]; then
        echo "$container_id"
        return 0
    fi

    # Try partial ID match among devbox containers
    if container_id=$(docker ps -aq --filter "name=^${CONTAINER_PREFIX}" | xargs -I {} docker inspect --format '{{.Id}} {{.Name}}' {} 2>/dev/null | grep "^$name_or_id" | head -1 | cut -d' ' -f1) && [[ -n "$container_id" ]]; then
        echo "$container_id"
        return 0
    fi

    # Not found
    return 1
}

# Usage/help function
usage() {
    cat << EOF
Devbox - Manage isolated, authenticated development containers

USAGE:
    devbox <command> [options]

COMMANDS:
    init                    One-time setup: authenticate GitHub CLI and Claude Code
    create <name> <repo>    Create and start a new container instance
    list                    List all devbox containers with status
    attach <name|id>        Attach to a running container's shell
    stop <name|id>          Stop a container (keeps state)
    start <name|id>         Start a stopped container
    rm <name|id>            Remove a container
    logs <name|id>          View container logs
    exec <name|id> <cmd>    Execute a command in a running container
    ports <name|id>         Show port mappings for a container
    help                    Show this help message

INIT OPTIONS:
    --bedrock              Skip Claude OAuth, configure for Bedrock mode
    --import-aws           Import existing AWS credentials from ~/.aws

CREATE OPTIONS:
    --port, -p <host:container>  Port mapping (repeatable)
    --bedrock              Use AWS Bedrock for Claude (sets CLAUDE_CODE_USE_BEDROCK=1)
    --aws-profile <profile>  AWS profile name

RM OPTIONS:
    --force                Force remove a running container

LOGS OPTIONS:
    -f, --follow           Follow log output

EXAMPLES:
    # First-time setup (OAuth mode)
    devbox init

    # First-time setup (Bedrock mode)
    devbox init --bedrock --import-aws

    # Create container with port mapping
    devbox create myapp git@github.com:org/repo.git --port 3000:3000

    # Create container for Bedrock
    devbox create myapp git@github.com:org/repo.git --bedrock --aws-profile prod

    # List containers
    devbox list

    # Attach to container
    devbox attach myapp

    # Execute command in container
    devbox exec myapp gh pr list

EOF
}

# Command implementations (stubs for now)
cmd_init() {
    log_error "Command 'init' not yet implemented"
    exit 1
}

cmd_create() {
    log_error "Command 'create' not yet implemented"
    exit 1
}

cmd_list() {
    log_error "Command 'list' not yet implemented"
    exit 1
}

cmd_attach() {
    log_error "Command 'attach' not yet implemented"
    exit 1
}

cmd_stop() {
    log_error "Command 'stop' not yet implemented"
    exit 1
}

cmd_start() {
    log_error "Command 'start' not yet implemented"
    exit 1
}

cmd_rm() {
    log_error "Command 'rm' not yet implemented"
    exit 1
}

cmd_logs() {
    log_error "Command 'logs' not yet implemented"
    exit 1
}

cmd_exec() {
    log_error "Command 'exec' not yet implemented"
    exit 1
}

cmd_ports() {
    log_error "Command 'ports' not yet implemented"
    exit 1
}

# Main command dispatcher
main() {
    # Check for help first
    if [[ $# -eq 0 ]] || [[ "$1" == "help" ]] || [[ "$1" == "-h" ]] || [[ "$1" == "--help" ]]; then
        usage
        exit 0
    fi

    # Check Docker is available (skip for help-only commands)
    check_docker

    # Ensure base image exists (skip for non-container commands)
    if [[ "$1" != "help" ]]; then
        ensure_image
    fi

    # Dispatch commands
    case "$1" in
        init)
            shift
            cmd_init "$@"
            ;;
        create)
            shift
            cmd_create "$@"
            ;;
        list)
            shift
            cmd_list "$@"
            ;;
        attach)
            shift
            cmd_attach "$@"
            ;;
        stop)
            shift
            cmd_stop "$@"
            ;;
        start)
            shift
            cmd_start "$@"
            ;;
        rm)
            shift
            cmd_rm "$@"
            ;;
        logs)
            shift
            cmd_logs "$@"
            ;;
        exec)
            shift
            cmd_exec "$@"
            ;;
        ports)
            shift
            cmd_ports "$@"
            ;;
        *)
            log_error "Unknown command: $1"
            echo
            usage
            exit 1
            ;;
    esac
}

# Entry point
main "$@"