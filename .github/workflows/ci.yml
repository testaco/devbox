name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install shellcheck
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck

    - name: Install shfmt
      run: |
        curl -sS https://webinstall.dev/shfmt | bash
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Run shellcheck
      run: |
        echo "Running shellcheck..."
        shellcheck --version

        # Check all bash files
        shellcheck --exclude=SC2155,SC2329,SC1091,SC1090,SC2034,SC2076,SC2086,SC2207,SC2206,SC2024,SC2317,SC2181 \
          bin/devbox \
          install.sh \
          docker/entrypoint.sh \
          docker/init-credentials.sh \
          tests/*.sh \
          completions/devbox.bash

    - name: Check code formatting
      run: |
        echo "Checking code formatting..."
        shfmt -version

        # Check if files need formatting (exit with error if diff found)
        shfmt -d \
          bin/devbox \
          install.sh \
          docker/entrypoint.sh \
          docker/init-credentials.sh \
          tests/*.sh \
          completions/devbox.bash

    - name: Run all tests
      run: |
        echo "Running all tests..."

        # Run all test files (except slow integration tests)
        EXIT_CODE=0
        for test_file in tests/test_*.sh; do
          # Skip slow integration tests that require expect and long nix setup
          if [[ "$test_file" == "tests/test_checkpoint3_integration.sh" ]]; then
            echo ""
            echo "==== Skipping $test_file (slow integration test) ===="
            continue
          fi
          if [[ -f "$test_file" ]]; then
            test_name=$(basename "$test_file" .sh)
            echo ""
            echo "==== Running $test_name ===="
            if bash "$test_file"; then
              echo "✓ $test_name passed"
            else
              echo "✗ $test_name failed"
              EXIT_CODE=1
            fi
          fi
        done

        exit $EXIT_CODE

    - name: Summary
      if: success()
      run: |
        echo "✅ All checks passed!"
